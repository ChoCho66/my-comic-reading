<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comic Reader</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #0f172a, #1f2937);
      --panel: rgba(255, 255, 255, 0.08);
      --accent: #f97316;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      --img-width: 100%;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Fira Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main { padding: 12px 14px; width: 100%; max-width: 1280px; margin: 0 auto; flex: 1; }
    .layout { display: flex; gap: 16px; align-items: flex-start; }
    .sidebar {
      width: 260px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 16px;
      align-self: flex-start;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .app-title { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }
    .side-group { display: flex; flex-direction: column; gap: 8px; }
    .side-label { font-size: 13px; color: var(--muted); font-weight: 600; }
    input[type="text"], input[type="number"], input[type="range"], select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }
    .row { display: flex; gap: 8px; align-items: center; }
    .hint { font-size: 12px; color: var(--muted); }
    button {
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 600;
      letter-spacing: 0.2px;
      width: 100%;
    }
    button:hover { border-color: rgba(249, 115, 22, 0.6); transform: translateY(-1px); }
    button.primary { background: var(--accent); color: #111827; border: none; }
    .controls-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    .content { flex: 1; min-width: 0; }
    .status { color: var(--muted); margin: 8px 0 12px; }
    .grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .card {
      background: var(--panel);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      padding: 8px;
      width: var(--img-width);
      max-width: 100%;
      margin: 0 auto;
    }
    .thumb {
      width: 100%;
      height: auto;
      object-fit: contain;
      background: #0b1222;
      cursor: pointer;
      display: block;
    }
    .caption {
      padding: 6px 2px 2px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }
    .pager { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pager span { color: var(--muted); font-weight: 600; }
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
      z-index: 10;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .modal img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #0f172a;
      flex: 1;
    }
    .modal-controls {
      position: absolute;
      left: 16px;
      top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 140px;
      background: rgba(15, 23, 42, 0.65);
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(6px);
    }
    .modal-caption { color: var(--muted); font-size: 13px; text-align: left; }
    .empty {
      text-align: center;
      color: var(--muted);
      margin-top: 50px;
    }
    @media (max-width: 640px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; position: relative; top: 0; }
      .thumb { height: 200px; }
      .modal-controls { width: auto; right: 16px; left: 16px; flex-direction: row; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <main>
    <div class="layout">
      <aside class="sidebar">
        <div class="app-title">Comic Reader</div>
        <div class="side-group">
          <div class="side-label">資料夾路徑</div>
          <div class="row">
            <input type="text" id="folderPath" placeholder="例如 /Users/you/comics" />
            <button id="loadBtn">載入</button>
          </div>
          <div class="hint">啟動後在此輸入要看的漫畫資料夾，按「載入」。</div>
        </div>
        <div class="side-group">
          <div class="side-label">瀏覽模式</div>
          <div class="controls-grid">
            <button class="primary" id="startSlide">投影片</button>
            <button id="showAll">全部瀏覽</button>
          </div>
        </div>
        <div class="side-group">
          <div class="side-label">分頁控制</div>
          <div class="controls-grid">
            <button id="prevPage">上一頁</button>
            <button id="nextPage">下一頁</button>
          </div>
          <div class="row">
            <select id="pageSelect"></select>
          </div>
          <div class="hint" id="pageInfo">第 0 / 0 頁</div>
        </div>
        <div class="side-group">
          <div class="side-label">圖片寬度 <span id="widthValue">100%</span></div>
          <input type="range" id="widthSlider" min="50" max="100" step="5" value="100" />
        </div>
        <div class="side-group">
          <div class="side-label">投影片控制</div>
          <div class="controls-grid">
            <button id="prevSlide">上一張</button>
            <button id="nextSlide">下一張</button>
          </div>
          <button id="closeModal">關閉投影片</button>
          <div class="hint" id="sidebarCaption">尚未開始</div>
        </div>
      </aside>
      <section class="content">
        <div class="status" id="status">請先選擇資料夾</div>
        <div class="grid" id="grid"></div>
        <div class="empty" id="empty" style="display:none;">No images found.</div>
      </section>
    </div>
  </main>

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-controls">
        <button id="prevSlideModal">上一張</button>
        <button id="nextSlideModal">下一張</button>
        <button id="closeModalModal">關閉</button>
        <div class="modal-caption" id="modalCaption">尚未開始</div>
      </div>
      <img id="modalImage" alt="Slide" />
    </div>
  </div>

  <script>
    const gridEl = document.getElementById("grid");
    const pageInfoEl = document.getElementById("pageInfo");
    const statusEl = document.getElementById("status");
    const emptyEl = document.getElementById("empty");
    const modalEl = document.getElementById("modal");
    const modalImage = document.getElementById("modalImage");
    const modalCaption = document.getElementById("modalCaption");
    const sidebarCaption = document.getElementById("sidebarCaption");
    const folderInput = document.getElementById("folderPath");
    const loadBtn = document.getElementById("loadBtn");
    const pageSelect = document.getElementById("pageSelect");
    const widthSlider = document.getElementById("widthSlider");
    const widthValue = document.getElementById("widthValue");
    const PAGE_SIZE = 20;
    let images = [];
    let currentPage = 1;
    let slideIndex = 0;
    let lastSlideIndex = 0;

    loadBtn.addEventListener("click", selectDirectory);
    pageSelect.addEventListener("change", onSelectPage);
    widthSlider.addEventListener("input", () => setWidth(widthSlider.value));
    document.getElementById("prevPage").addEventListener("click", () => changePage(-1));
    document.getElementById("nextPage").addEventListener("click", () => changePage(1));
    document.getElementById("startSlide").addEventListener("click", () => startSlideshow());
    document.getElementById("showAll").addEventListener("click", () => renderPage(currentPage));
    document.getElementById("prevSlide").addEventListener("click", () => moveSlide(-1));
    document.getElementById("nextSlide").addEventListener("click", () => moveSlide(1));
    document.getElementById("closeModal").addEventListener("click", closeModal);
    document.getElementById("prevSlideModal").addEventListener("click", () => moveSlide(-1));
    document.getElementById("nextSlideModal").addEventListener("click", () => moveSlide(1));
    document.getElementById("closeModalModal").addEventListener("click", closeModal);
    modalEl.addEventListener("click", (e) => { if (e.target === modalEl) closeModal(); });
    document.addEventListener("keydown", (e) => {
      const isFormField = e.target instanceof HTMLElement &&
        ["INPUT", "TEXTAREA", "SELECT"].includes(e.target.tagName);

      if (modalEl.classList.contains("active")) {
        if (e.key === "ArrowRight") moveSlide(1);
        if (e.key === "ArrowLeft") moveSlide(-1);
        if (e.key === "Escape") closeModal();
        if (e.key === "a" || e.key === "A") {
          closeModal();
          renderPage(currentPage);
        }
        return;
      }

      if (isFormField) return;
      if (e.key === "s" || e.key === "S") {
        startSlideshow();
        e.preventDefault();
        return;
      }
      if (e.key === "a" || e.key === "A") {
        renderPage(currentPage);
        e.preventDefault();
        return;
      }
      if (e.key === "ArrowRight") {
        changePage(1);
        e.preventDefault();
      }
      if (e.key === "ArrowLeft") {
        changePage(-1);
        e.preventDefault();
      }
    });

    async function selectDirectory() {
      const path = folderInput.value.trim();
      if (!path) {
        statusEl.textContent = "請輸入資料夾路徑";
        return;
      }
      statusEl.textContent = "載入中...";
      try {
        const res = await fetch("/api/select-dir", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          statusEl.textContent = data.message || "載入失敗";
          return;
        }
        statusEl.textContent = `載入完成，共 ${data.count} 張`;
        await loadImages();
      } catch (err) {
        statusEl.textContent = "載入失敗，請確認路徑";
        console.error(err);
      }
    }

    async function loadImages() {
      try {
        const res = await fetch("/api/images");
        const data = await res.json();
        images = data.images || [];
        if (!images.length) {
          statusEl.textContent = "請先選擇資料夾";
          emptyEl.style.display = "block";
          return;
        }
        statusEl.textContent = `共 ${images.length} 張，分頁顯示，每頁 ${PAGE_SIZE} 張`;
        renderPage(1);
      } catch (err) {
        statusEl.textContent = "Failed to load images.";
        console.error(err);
      }
    }

    function renderPage(page = 1) {
      currentPage = page;
      const start = (page - 1) * PAGE_SIZE;
      const slice = images.slice(start, start + PAGE_SIZE);

      gridEl.innerHTML = "";
      slice.forEach((name, idx) => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.className = "thumb";
        img.src = `/images/${name}`;
        img.alt = name;
        img.loading = "lazy";
        img.addEventListener("click", () => startSlideshow(start + idx));

        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = name;

        card.appendChild(img);
        card.appendChild(cap);
        gridEl.appendChild(card);
      });

      const totalPages = Math.max(1, Math.ceil(images.length / PAGE_SIZE));
      pageInfoEl.textContent = `第 ${page} / ${totalPages} 頁`;
      document.getElementById("prevPage").disabled = page <= 1;
      document.getElementById("nextPage").disabled = page >= totalPages;
      updatePageSelect(totalPages);
      pageSelect.value = String(page);
    }

    function changePage(delta) {
      const next = currentPage + delta;
      const totalPages = Math.max(1, Math.ceil(images.length / PAGE_SIZE));
      if (next < 1 || next > totalPages) return;
      renderPage(next);
    }

    function updatePageSelect(totalPages) {
      if (!pageSelect) return;
      const frag = document.createDocumentFragment();
      for (let i = 1; i <= totalPages; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `第 ${i} 頁`;
        frag.appendChild(opt);
      }
      pageSelect.innerHTML = "";
      pageSelect.appendChild(frag);
    }

    function onSelectPage() {
      const totalPages = Math.max(1, Math.ceil(images.length / PAGE_SIZE));
      const target = parseInt(pageSelect.value, 10);
      if (!Number.isFinite(target)) return;
      const page = Math.min(Math.max(target, 1), totalPages);
      renderPage(page);
    }

    function setWidth(val) {
      // Snap to the nearest 5% so widths are 100%, 95%, 90%, ...
      const num = Number(val);
      const clamped = Math.min(100, Math.max(50, Number.isFinite(num) ? num : 100));
      const snapped = Math.round(clamped / 5) * 5;
      widthSlider.value = snapped;
      document.documentElement.style.setProperty("--img-width", `${snapped}%`);
      widthValue.textContent = `${snapped}%`;
    }

    function currentPageStartIndex() {
      return (currentPage - 1) * PAGE_SIZE;
    }

    function startSlideshow(index) {
      if (!images.length) return;
      const fallback = currentPageStartIndex();
      const target = typeof index === "number" ? index : lastSlideIndex || fallback;
      slideIndex = (target + images.length) % images.length;
      updateSlide();
      modalEl.classList.add("active");
    }

    function moveSlide(delta) {
      if (!images.length) return;
      slideIndex = (slideIndex + delta + images.length) % images.length;
      updateSlide();
    }

    function updateSlide() {
      lastSlideIndex = slideIndex;
      const name = images[slideIndex];
      modalImage.src = `/images/${name}`;
      const captionText = `${slideIndex + 1} / ${images.length} - ${name}`;
      modalCaption.textContent = captionText;
      sidebarCaption.textContent = captionText;
    }

    function closeModal() {
      modalEl.classList.remove("active");
    }

    loadImages();
    setWidth(widthSlider.value);
  </script>
</body>
</html>
